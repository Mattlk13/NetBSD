VERSION: :1,$s/2021-09-18/2021-09-18/g
ISO:     :1,$s/202109160900Z/202109160900Z/g
NetBSD:  :1,$s/9.99.88/9.99.88/g
PKGSRC:  :1,$s/2021-09-18/2021-1/
# Check MD5 filename before post this mail.
# why dont we take off alone.

To: port-armNetBSD.org@localhost
Subject: 2021-09-18-netbsd-raspi-earmv6hf.img (Re: Raspberry Pi update please.)
From: Jun Ebihara <jun@soum.co.jp>

I've updated 2021-09-18-netbsd-raspi-earmv6hf.img.gz for RPI.

https://cdn.netbsd.org/pub/NetBSD/misc/jun/raspberry-pi/2021-09-18-earmv6hf/2021-09-18-netbsd-raspi-earmv6hf.img.gz
https://cdn.netbsd.org/pub/NetBSD/misc/jun/raspberry-pi/2021-09-18-earmv6hf/MD5

Update:
- NetBSD 9.99.88 evbarm-earmv6hf 202109160900Z rpi.img from nyftp.
- openssh-8.7
- git-base-2.33.0 
- glib2-2.68.4
- perl-5.34.0nb3
- python38-3.8.12 
- ruby27-mikutter-4.1.6
- wget-1.21.2

Problem:
- backout kernel.img/kernel7.img
RPI3(A/B/B+) boot failed with Sep.16. backout Aug.20 version.
 Stopped at rainbow screen.
RPI2 boot fine.

/boot/kernel7.img
 RPI3B boot:	NetBSD 9.99.88 (RPI2) #0: Fri Aug 20 20:25:28 UTC 2021
/boot/kernel7.img.original
 RPI3B fail:	NetBSD 9.99.88 (RPI2) #0: Thu Sep 16 08:33:24 UTC 2021

- Ruby dependancy
backout ruby27-glib2-3.4.3 related libs.
pkg_add -U ruby27-glib2-3.4.3  #Ruby binding of GLib-2.x
pkg_add -U ruby27-atk-3.4.3    #Ruby binding of ATK-1.0.x or later
pkg_add -U ruby27-cairo-gobject-3.4.3 #Ruby binding of cairo-gobject
pkg_add -U ruby27-pango-3.4.3  #Ruby binding of pango-1.x
pkg_add -U ruby27-gio2-3.4.3   #Ruby binding of gio-2.0.x
pkg_add -U ruby27-gobject-introspection-3.4.3 #Ruby binding of Gobject Introspection
pkg_add -U ruby27-gdk_pixbuf2-3.4.3 #Ruby binding of GdkPixbuf-2.x
pkg_add -U ruby27-mini_portile2-2.6.1

- Raspberry Pi [0-3] have been supported in big-endian mode (Rin Okuyama)
XXX: should test big-endian image and pkgsrc

http://mail-index.netbsd.org/port-arm/2021/06/17/msg007310.html
 "earmv7hfeb works fine so far, pkgsrc included. aarc64eb doesn't boot
  on a Raspberry Pi 3," 

PR
#55505 RaspberryPi3A+ can't find Wi-Fi module
 http://gnats.netbsd.org/cgi-bin/query-pr-single.pl?number=55505

#54941
 Raspberry Pi Zero W serial console corrupted when CPU frequency changed
 http://gnats.netbsd.org/54941

- RPI4: testing on NetBSD/aarch64
  https://github.com/ebijun/NetBSD/blob/master/RPI/RPIimage/Image/aarch64/README

Changes from 2021-08-23 version
https://github.com/ebijun/NetBSD/commit/47e8ff0a095f64de8e0efb395d20fd2bc4e30701

- pkgin support
  check /usr/pkg/etc/pkgin/repositories.conf.
  I add 
  http://cdn.netbsd.org/pub/NetBSD/misc/jun/raspberry-pi/earmv6hf/2021-1
  for testing, with pkg_summery.gz .

sysinfo:
 bozohttpd-20210824 libssh-41.0 openssh-8.7 opensshd-8.7
 sh-20181212-20210916083324Z

pkgsrc:
 curl-7.79.0 git-base-2.33.0 glib2-2.68.4 libgcrypt-1.9.4
 libwebp-1.2.1 libxkbcommon-1.3.1 p11-kit-0.24.0nb3
 p5-IO-Socket-SSL-2.072 p5-Net-DNS-1.32 pango-1.48.9
 perl-5.34.0nb3 py38-cElementTree-3.8.12 py38-expat-3.8.12
 python38-3.8.12 ruby27-addressable-2.8.0 ruby27-atk-3.4.9
 ruby27-cairo-gobject-3.4.9 ruby27-delayer-1.2.1 ruby27-diva-1.1.0
 ruby27-gdk_pixbuf2-3.4.9 ruby27-gettext-3.4.0 ruby27-gio2-3.4.9
 ruby27-glib2-3.4.9 ruby27-gobject-introspection-3.4.9
 ruby27-gtk2-3.4.3nb1 ruby27-mikutter-4.1.6
 ruby27-mini_portile2-2.7.0 ruby27-nokogiri-1.12.3
 ruby27-pango-3.4.9 ruby27-red-colors-0.3.0
 wget-1.21.2

Need Checking:
- bluetooth keyboard/mouse setting
- RPI camera module

Got Reports:
- HDMI output works very well however I wanted to change the resolution
  into 800x600 both tty console and X Window graphical modes. Where should I
  change it? As config.txt with hdmi_group=1, hdmi_mode=1 or hdmi_safe=1
  didn't work.
- USB input devices seem to work fine as well with my USB keyboard, mouse
  and barcode reader. However for my USB output device such as my Xprinter
  printer didn't work with device driver of ulpt(4). It is detected
  and working in OpenBSD.[9.0 release also occurs same error]

  [   195.114857] ulpt0 at uhub1 port 5 configuration 1 interface 0
  [   195.114857] ulpt0: Xprinter (0x0483) USB Printer P (0x5743), rev 2.00/1.00, addr 5, iclass 7/1
  [   195.114857] ulpt0: using bi-directional mode

  rpi# cat myfile.txt > /dev/ulpt0
  -sh: cannot create /dev/ulpt0: error 16
- with my Raspberry Pi 3B because every time I invoked this command 
 "shutdown -h now" a kernel panic occurs relating to usbd_transfer.
- After shutting-down leaving the system unplugged, this will
  turn it's processor very very hot and seems harmful to the system.

pre-installed packages:
 https://github.com/ebijun/NetBSD/blob/master/RPI/RPIimage/pkgsrc/pkginfo

Keyboard layout checkpoint:
 http://www.netbsd.org/docs/guide/en/chap-cons.html

/etc/wscons.conf
 #encoding sv
 #encoding us.swapctrlcaps
 encoding jp

System Update:

http://cvsweb.netbsd.org/bsdweb.cgi/src/distrib/sets/lists/base/shl.mi

mikutter support : 
 I make sample API key,pre-installed.
 https://github.com/ebijun/NetBSD/tree/master/RPI/RPIimage/root/.mikutter/plugin
 https://github.com/Akkiesoft/how-to-make-mikutter-work-again
  cd /root/.mikutter
  git submodule add https://github.com/toshia/twitter_api_keys.git twitter_api_keys

RPI Wifi:
 http://mail-index.netbsd.org/port-arm/2019/08/31/msg006102.html

Overview:
  http://wiki.NetBSD.org/ports/evbarm/raspberry_pi/

QEMU,with GENERIC kernel : vexpress to GENERIC: testing
 https://github.com/ebijun/NetBSD/tree/master/vexpress/Boot
 https://github.com/ebijun/NetBSD/tree/master/vexpress/vexpress-v2p-ca15-tc1.dtb
 http://cdn.netbsd.org/pub/NetBSD/misc/jun/raspberry-pi/2021-09-18-earmv6hf/QEMU/netbsd-GENERIC.ub.gz
 http://mail-index.netbsd.org/port-arm/2017/06/02/msg004154.html

dmesg:
  https://github.com/ebijun/NetBSD/blob/master/dmesg/earmv6hf/RPI
  https://github.com/ebijun/NetBSD/blob/master/dmesg/earmv6hf/RPI0
  https://github.com/ebijun/NetBSD/blob/master/dmesg/earmv6hf/RPI0W
  https://github.com/ebijun/NetBSD/blob/master/dmesg/earmv6hf/RPI2
  https://github.com/ebijun/NetBSD/blob/master/dmesg/earmv6hf/RPI2-1.2
  https://github.com/ebijun/NetBSD/blob/master/dmesg/earmv6hf/RPI3
  https://github.com/ebijun/NetBSD/blob/master/dmesg/earmv6hf/RPI3A+
  https://github.com/ebijun/NetBSD/blob/master/dmesg/earmv6hf/RPI3B+

Problem:
- CPUFLAGS=-mfpu=neon-vfpv4 breaks some programs
  http://gnats.netbsd.org/52528
- webkit24-gtk-2.4.11nb9 compile failed.
- dillo-3.0.5nb2 works with -O0
  thanx Jared McNeill.

security.pax.mprotect.enabled
  http://netbsd.org/gallery/presentations/msaitoh/2016_BSDCan/BSDCan2016-NetBSD.pdf
  man security
  man paxctl
  sysctl -a |grep pax
  If application failed, such as omxplayer.
  try to test 
  sysctl -w security.pax.mprotect.enabled=0 

Automatic resize partition: see /etc/rc.conf and /etc/fstab
  1. copy image to SD/MicroSD
  2. Boot 
  3. Calculate and resize ld0 partition and automatic reboot
  4. after the reboot,root partition fit for your card.
    http://movapic.com/pic/20150416115108552fa22c4f225
    In this image, ld0a re-created with newfs -b 4096.

pkgsrc: 
  # cd /usr
  # ftp http://cdn.netbsd.org/pub/pkgsrc/current/pkgsrc.tar.gz
  # ls /usr/pkgsrc                ... check if exists.
  # tar tzvf pkgsrc.tar.gz |head  ... check the archive
  # tar xzvf pkgsrc.tar.gz        ... extract
  # ls /usr/pkgsrc                ... check what extracted
  # pkg_chk -g                    ... List to/usr/pkgsrc/pkgchk.conf
  # (cd /usr/pkgsrc;cvs update -PAd) ... update
  # pkg_chk -un                   ... Update (listup)
  # pkg_chk -u                    ... Update

  I use /usr/pkgsrc with USB SSD disk.

Pre-compiled packages:
- Pre-compiled packages path setting: man 5 pkg_install.conf

See /etc/pkg_install.conf

PKG_PATH=http://cdn.netbsd.org/pub/NetBSD/misc/jun/raspberry-pi/earmv6hf/2021-1/

- If you use Official Package for NetBSD9:

set /etc/pkg_install.conf: 
PKG_PATH=http://cdn.netbsd.org/pub/pkgsrc/packages/NetBSD/earmv6hf/9.0/

- If you update pkgsrc by yourself,comment out /etc/pkg_install.conf and check
 /etc/mk.conf.

Install application: man 1 pkg_add
  # pkg_add some_application_name

- omxplayer
  # pkg_add omxplayer
  # pkg_add youtube-dl
  # youtube-dl https://www.youtube.com/watch?v=wG8ZCC8IwvM
  # omxplayer *.mkv
  MPEG-2 license key: 
   sysctl machdep.serial and convert to hex.

- Xfce4
  # pkg_add xfce4
  # startxfce4 
   or edit /root/.xinitrc and comment out startxfce4

- seamonkey
  # pkg_add seamonkey
  # pkg_add seamonkey-l10n

- nodejs
  # pkg_add nodejs

  omxfinder (https://www.npmjs.com/package/omxfinder)
  # npm install -g omxfinder
  cd video archive directory,
  # omxfinder
  can start video viewing via file finder.

  SHARP MZ700 emulator
  # npm install -g mz700-js
  # cd /usr/pkg/lib/node_modules/mz700-js
  # npm start
  # mz700-js@0.0.0 start  /usr/pkg/lib/node_modules/mz700-js
  # access http://localhost:3000/MZ-700/client.html

- openjdk
  # pkg_add openjdk8

- gimp
  # pkg_add gimp

- mpv
  # pkg_add mpv

- emacs
  # pkg_add emacs
  # pkg_add anthy-elisp # for inputmethod/anthy

- evince
  # pkg_add evince

- typical apache+php environment
  # pkg_add ap22-php56

- gedit
  # pkg_add gedit

- sphinx
  # pkg_add py27-sphinx

- mcomix .. Book scanning data viewer
  # pkg_add py27-mcomix
  to avoid ImportError: cannot import name _getexif,
  use py27-Pillow package instead of py27-imaging.

- firefox52
  # pkg_add firefox52
  # pkg_add firefox52-l10n
  firefox52: fixed by Jared McNeill.
   http://mail-index.netbsd.org/pkgsrc-changes/2017/07/16/msg160171.html

- awscli
  # pkg_add py27-awscli
  # /usr/pkg/bin/aws ec2 describe-instances ....

Testing:: 

- midori 
  # pkg_add midori
  XXX: start failed

- scribus
  # pkg_add scribus-1.4.3  
  XXX: libpodofo.so.0.9.3 not found:need re-compile

- inkscape
  XXX: libboost_system.so.1.60 not found:need re-compile

- wordpress
  # pkg_add wordpress
  XXX: need php56-gd

- (shotwell)
  # pkg_add shotwell

USB mass storage boot
 https://www.raspberrypi.org/documentation/hardware/raspberrypi/bootmodes/msd.md

CrossCompiling:
  http://www.slideshare.net/junebihara18/netbsdworkshop

NetBSD GPIO DOC by Marina Brown
  https://github.com/catskillmarina/netbsd-gpio-doc/blob/master/README.md

I2C - "Raspberry Pi I2C implementation still broken?"
  http://mail-index.netbsd.org/port-arm/2015/02/10/msg002853.html
  "I can confirm the IOCTL is fixed, and can now successfully program I2C 
  EEPROMs using NetBSD on the Pi."
  NetBSD RPi i2c sample code:
   https://gist.github.com/cr1901/76af0b3db9e9001a8d5b
   http://gnats.netbsd.org/cgi-bin/query-pr-single.pl?number=48855
   http://gnats.netbsd.org/cgi-bin/query-pr-single.pl?number=48932

XM6i - SHARP X68030 Emulator for NetBSD/x68k (Thanx isaki@)
  http://www.pastel-flower.jp/~isaki/XM6i/
  XM6i-0.55-netbsd7.0-earmv6hf-2015Q2.tar.gz
  pkg_add wxGTK30-3.0.2nb6
  XXX: use wxGTK30-3.0.2nb6 for XM6i-0.55

  https://twitter.com/isaki68k/status/625138538271502337

Todo:
- set2pkg: update via pkgsrc.
- pkg_in/pkg_summary
- Summarize /usr/tests atf result on earm/earmhf/earmv6hf.
- DTRACE http://wiki.netbsd.org/tutorials/how_to_enable_and_run_dtrace/
- yaft (yet another framebuffer terminal):
  https://github.com/uobikiemukot/yaft
- /dev/mem: http://mail-index.netbsd.org/port-arm/2015/03/12/msg002934.html
  "can't open /dev/mem" -> re-compile kernel with INSECURE.
- Sound output to the jack: port-arm/2015/03/12/msg002938.html
   $ mixerctl -v outputs.select
   outputs.select=auto  [ auto headphones hdmi ]

pkgsrc Todo:
- lang/go : 
  earmv7hf: pkgsrc: go-1.9.3.tgz go14-1.4.3nb6.tgz or later.
  earmv6hf: pkgsrc: go14-1.4.3nb6.tgz

  Golang for NetBSD/arm problem summarized by @oshimyja
  http://www.yagoto-urayama.jp/~oshimaya/netbsd/netbsd_goarm.html
  http://mail-index.netbsd.org/port-arm/2015/08/02/msg003361.html
  https://twitter.com/oshimyja/status/604871730125864960
  https://twitter.com/oshimyja/status/840750347022876672
  https://github.com/golang/go/commit/30d60936d97423af0403f2d5395c604ac0ff3757
  runtime: fetch physical page size from the OS 
   https://github.com/golang/go/commit/276a52de55fb48c4e56a778f1f7cac9292d8fad7
- gnuradio: g77 failed. need RTL2832U master.
  http://mail-index.netbsd.org/port-arm/2017/01/26/msg004090.html
- www/otter-browser: compiling.
- omxplayer: sometimes core dumps.
  -> add "gpu=256" to /boot/cmdline.txt, advice from Brandon Wickelhaus.


=====================

For Open Developers Conference 2021, NetBSD BOF.
I've updated raspberry-pi image.

2021 Aug.28 Sat 14:00-14:45 JST (UTC+9) ROOM C
https://event.ospn.jp/odc2021-online/session/375193

Join meeting with ZOOM/YoutubeLive 
  https://ospn.connpass.com/event/216508/
YoutubeLive https://www.youtube.com/c/OSPNjp

http://www.re.soum.co.jp/~jun/ODC2021.pdf
http://www.jp.NetBSD.org/
https://www.facebook.com/NetBSD.jp 
https://github.com/ebijun/NetBSD/blob/master/Guide/RPI/RPIupdate2021.rst

- NetBSD 9.99.88 earmv6hf rpi.img.gz base
- Connect HDMI,USB Keyboard,USB Mouse,Ether(dhcpd and ntpd will work)
- login root (no passwd)
- startx ,and icewm running.
- running mikutter.
  twitter client (net/mikutter) on 40inch home TV.
  http://movapic.com/ebijun/pic/5168479

  # startx
  # dillo &
  # mikutter &
  or
  # LANG=en_US.UTF-8 mikutter &
       English menu support. LANG environment setting on .xinitrc .

  ==== one or two or threee moment =====

Appear mikutter window. and mikutter-chan tell you,

"Well done on the installation!" [Next]
"Hi! This is mikutter-chan speaking to you,join the twitter with me!" [Next]
 1. "Click the link https:......" click the URL, 
    copy URL into dillo.
 2. "login with the Twitter account you wish to use."
 3. "Go along until you see a 7-digit code and type it in at the top."
  -> get pin number.
  -> paste pin number to mikutter
 4. "Congratulations! You have attained achievement register_account!"

  Share your twitter timeline with your family!

Features:
  - fit size for 4GB SD Card
  - with X11
  - increase more inodes on /dev/ld0a
  - Recent current RPI kernel
  - USB/video support: as NetBSD-current 
  - pre-build packages
    http://cdn.netbsd.org/pub/NetBSD/misc/jun/raspberry-pi/earmv6hf/2021-1/

Installed Packages:
  bash
  tcsh
  vlgothic-ttf
  icewm
  xli
  ruby27-mikutter
  uim
  fossil
  raspberrypi-userland
  sudo
  git-base
  zsh
  mlterm
  pkg_chk
  lintpkgsrc
  mozilla-rootcerts
  dillo
  medit
  lrzsz

To control HDMI output,add/delete "console=fb" on cmdline.txt.
If delete console=fb definition,you can get serial console instead.
 rpi$ more /boot/cmdline.txt
 root=ld0a console=fb


/root/.xinitrc
 setxkbmap -model jp106 jp

/root/.mikutter/plugin/ : http://yuzuki.hachune.net/wiki/Plugin
- display_requirements.rb [Pre installed]

Build sample script:
 https://github.com/ebijun/NetBSD/tree/master/RPI/RPIimage/Image

Guide:
 https://github.com/ebijun/NetBSD/blob/master/Guide/RPI.rst

BUGS:
1. port-arm/48855
  i2cscan on RPi NetBSD build finds device for all addresses
2. i2c problem reported from "its sead".
  /usr/sbin/i2scan on iic0 or iic1 often crashes the device (also with the -r 
  (use writes) option)
3. cap_mkdb failed, on update terminfo db.
  https://twitter.com/uobikiemukot/status/487977340949893121

One more time: (we're gonna celebrate
- Everything you always wanted to know about six but were afraid to ask.

 1. login root
 2. mlterm-wscons 
 3. ftp http://mlterm.sf.net/vimperator.six
 4. cat vimperator.six
 5. exit 
 6. mlterm-wscons --rotate=left
 7. cat vimperator.six
    and @Chris_J_Baird only knows how to get to 1987.
 8. ftp http://kildall.apana.org.au/~cjb/mandel5.c
 9. cc mandel5.c
10. ./a.out 1024 728 -2 -1.5 4.0 |tee f
11. cat f

--
Jun Ebihara
